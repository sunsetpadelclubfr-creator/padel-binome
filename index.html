<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Padel Binôme</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:system-ui;margin:16px}
.card{max-width:900px;margin:auto;border:1px solid #ddd;border-radius:14px;padding:16px}
input,select,button,textarea{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:10px}
button{cursor:pointer}
.row{display:flex;gap:10px}.row>*{flex:1}
.hidden{display:none}.muted{color:#666;font-size:14px}
.badge{border:1px solid #ccc;border-radius:999px;padding:2px 8px;font-size:12px}
.messages{height:300px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:8px;background:#fafafa}
.msg{max-width:70%;margin:4px 0;padding:6px 8px;border-radius:10px}
.me{margin-left:auto;background:#e8f5ff}.them{background:#eee}
</style>
</head>
<body>

<div class="card">
<h2>Padel Binôme</h2>

<div id="authView">
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Mot de passe">
<div class="row">
<button id="btnLogin">Se connecter</button>
<button id="btnSignup">Créer un compte</button>
</div>
<p id="authMsg" class="muted"></p>
</div>

<div id="appView" class="hidden">
<p id="userLine"></p>
<button id="btnLogout">Se déconnecter</button>

<h3>Profil</h3>
<input id="display_name" placeholder="Pseudo">
<input id="department" placeholder="Département">
<button id="btnSave">Enregistrer</button>
<p id="saveMsg" class="muted"></p>

<h3>Matching</h3>
<button id="btnFind">Trouver un binôme</button>
<div id="results"></div>

<h3>Mes conversations</h3>
<div id="inbox"></div>
<p id="inboxMsg" class="muted"></p>

<div id="chatSection" class="hidden">
<h3 id="chatWithName"></h3>
<div class="messages" id="messages"></div>
<textarea id="msgInput"></textarea>
<button id="btnSend">Envoyer</button>
<p id="chatMsg" class="muted"></p>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, increment,
 collection, getDocs, query, where, orderBy, addDoc, onSnapshot } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyAN3k8oOsG_42wRmmkdHqKs7XjIamNiVy4",
authDomain:"padel-binome.firebaseapp.com",
projectId:"padel-binome",
storageBucket:"padel-binome.firebasestorage.app",
messagingSenderId:"968501656511",
appId:"1:968501656511:web:464dca20866e202d53ff0a"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

const authView=document.getElementById("authView");
const appView=document.getElementById("appView");
const authMsg=document.getElementById("authMsg");
const saveMsg=document.getElementById("saveMsg");
const results=document.getElementById("results");
const inbox=document.getElementById("inbox");
const inboxMsg=document.getElementById("inboxMsg");
const chatSection=document.getElementById("chatSection");
const messages=document.getElementById("messages");
const chatWithName=document.getElementById("chatWithName");
const chatMsg=document.getElementById("chatMsg");

const email=document.getElementById("email");
const password=document.getElementById("password");
const display_name=document.getElementById("display_name");
const department=document.getElementById("department");
const msgInput=document.getElementById("msgInput");

let currentUser=null;
let currentProfile=null;
let currentChatId=null;
let currentOtherUid=null;
let unsubscribe=null;

/* AUTH */
btnSignup.onclick=async()=>{
 try{await createUserWithEmailAndPassword(auth,email.value,password.value);}
 catch(e){authMsg.textContent=e.message;}
};
btnLogin.onclick=async()=>{
 try{await signInWithEmailAndPassword(auth,email.value,password.value);}
 catch(e){authMsg.textContent=e.message;}
};
btnLogout.onclick=()=>signOut(auth);

/* PROFIL */
async function loadProfile(uid){
 const s=await getDoc(doc(db,"profiles",uid));
 if(!s.exists())return null;
 const p=s.data();
 display_name.value=p.display_name||"";
 department.value=p.department||"";
 return p;
}
btnSave.onclick=async()=>{
 const p={display_name:display_name.value,department:department.value,is_active:true,updated_at:serverTimestamp()};
 await setDoc(doc(db,"profiles",currentUser.uid),p,{merge:true});
 currentProfile=p; saveMsg.textContent="Profil enregistré";
};

/* MATCHING */
btnFind.onclick=async()=>{
 const q=query(collection(db,"profiles"),where("is_active","==",true));
 const snap=await getDocs(q);
 let html="";
 snap.forEach(d=>{
   if(d.id===currentUser.uid)return;
   const p=d.data();
   if(p.department!==currentProfile.department)return;
   html+=`<div>${p.display_name} <button data-uid="${d.id}" data-name="${p.display_name}">Contacter</button></div>`;
 });
 results.innerHTML=html;
 document.querySelectorAll("#results button").forEach(b=>{
  b.onclick=()=>openChat(b.dataset.uid,b.dataset.name);
 });
};

/* CHAT */
function pairKey(a,b){return a<b?`${a}_${b}`:`${b}_${a}`;}

async function openChat(otherUid,otherName,forced=null){
 chatWithName.textContent=otherName;
 chatSection.classList.remove("hidden");
 messages.innerHTML="Chargement...";
 if(unsubscribe)unsubscribe();
 let chatId=forced;
 let chatRef;
 if(!chatId){
   chatId=pairKey(currentUser.uid,otherUid);
   chatRef=doc(db,"chats",chatId);
   await setDoc(chatRef,{participants:[currentUser.uid,otherUid],created_at:serverTimestamp()},{merge:true});
 }else chatRef=doc(db,"chats",chatId);

 currentChatId=chatId;
 currentOtherUid=otherUid;

 unsubscribe=onSnapshot(query(collection(db,"chats",chatId,"messages"),orderBy("created_at")),
  snap=>{
    messages.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg "+(m.sender_id===currentUser.uid?"me":"them");
      div.textContent=m.content;
      messages.appendChild(div);
    });
    messages.scrollTop=messages.scrollHeight;
 });

 btnSend.onclick=async()=>{
  const text=msgInput.value.trim();
  if(!text)return;
  await addDoc(collection(db,"chats",chatId,"messages"),{
   sender_id:currentUser.uid,
   recipient_id:otherUid,
   content:text,
   created_at:serverTimestamp(),
   read_by:[currentUser.uid]
  });
  await setDoc(doc(db,"user_inbox",otherUid,"threads",chatId),{
   other_uid:currentUser.uid,
   other_name:currentProfile.display_name,
   last_message_at:serverTimestamp(),
   last_message_preview:text,
   unread:increment(1)
  },{merge:true});
  await setDoc(doc(db,"user_inbox",currentUser.uid,"threads",chatId),{
   other_uid:otherUid,
   other_name:otherName,
   last_message_at:serverTimestamp(),
   last_message_preview:text,
   unread:0
  },{merge:true});
  msgInput.value="";
  loadInbox();
 };
}

/* INBOX */
async function loadInbox(){
 inbox.innerHTML="Chargement...";
 try{
 const q=query(collection(db,"user_inbox",currentUser.uid,"threads"),orderBy("last_message_at","desc"));
 const snap=await getDocs(q);
 if(snap.empty){inbox.innerHTML="Aucune conversation";return;}
 let html="";
 snap.forEach(d=>{
  const t=d.data();
  html+=`<div>
   <strong>${t.other_name}</strong>
   ${t.unread>0?`<span class="badge">${t.unread}</span>`:""}
   <br>${t.last_message_preview}
   <button data-chat="${d.id}" data-other="${t.other_uid}" data-name="${t.other_name}">Ouvrir</button>
  </div>`;
 });
 inbox.innerHTML=html;
 inbox.querySelectorAll("button").forEach(b=>{
  b.onclick=async()=>{
    await openChat(b.dataset.other,b.dataset.name,b.dataset.chat);
    await setDoc(doc(db,"user_inbox",currentUser.uid,"threads",b.dataset.chat),{unread:0},{merge:true});
    loadInbox();
  };
 });
 }catch(e){
  inbox.innerHTML="Inbox indisponible";
  inboxMsg.textContent=e.message;
 }
}

/* AUTH STATE */
onAuthStateChanged(auth,async u=>{
 currentUser=u;
 if(!u){authView.classList.remove("hidden");appView.classList.add("hidden");return;}
 authView.classList.add("hidden");appView.classList.remove("hidden");
 userLine.textContent="Connecté: "+u.email;
 currentProfile=await loadProfile(u.uid);
 loadInbox();
});
</script>
</body>
</html>

