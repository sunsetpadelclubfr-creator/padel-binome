<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Padel Binôme</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:system-ui;margin:12px}
input,button,textarea{width:100%;padding:10px;margin:6px 0}
.hidden{display:none}
.box{border:1px solid #ccc;padding:10px;margin:8px 0}
.msg{margin:4px 0;padding:6px;border-radius:6px}
.me{background:#dff}
.them{background:#eee}
</style>
</head>
<body>

<h2>Padel Binôme</h2>

<div id="authView">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Mot de passe">
  <button id="btnLogin" type="button">Se connecter</button>
  <button id="btnSignup" type="button">Créer un compte</button>
  <p id="authMsg"></p>
</div>

<div id="appView" class="hidden">
  <p id="userLine"></p>
  <button id="btnLogout" type="button">Se déconnecter</button>

  <h3>Mon profil</h3>
  <input id="display_name" placeholder="Pseudo">
  <input id="department" placeholder="Département">
  <button id="btnSave" type="button">Enregistrer</button>
  <p id="saveMsg"></p>

  <h3>Binômes</h3>
  <button id="btnFind" type="button">Rechercher</button>
  <div id="results"></div>

  <h3>Mes conversations</h3>
  <button id="btnInbox" type="button">Rafraîchir</button>
  <div id="inbox"></div>

  <div id="chatSection" class="hidden">
    <h3 id="chatTitle"></h3>
    <div id="messages"></div>
    <textarea id="msgInput"></textarea>
    <button id="btnSend" type="button">Envoyer</button>
    <p id="chatMsg"></p>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { describes as a, getAuth, onAuthStateChanged,
  createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp,
  collection, getDocs, query, where, orderBy, limit, addDoc, onSnapshot }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAN3k8oOsG_42wRmmkdHqKs7XjIamNiVy4",
  authDomain: "padel-binome.firebaseapp.com",
  projectId: "padel-binome",
  storageBucket: "padel-binome.firebasestorage.app",
  messagingSenderId: "968501656511",
  appId: "1:968501656511:web:464dca20866e202d53ff0a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const authView = document.getElementById("authView");
const appView = document.getElementById("appView");
const authMsg = document.getElementById("authMsg");
const email = document.getElementById("email");
const password = document.getElementById("password");
const btnLogin = document.getElementById("btnLogin");
const btnSignup = document.getElementById("btnSignup");
const btnLogout = document.getElementById("btnLogout");
const userLine = document.getElementById("userLine");

const display_name = document.getElementById("display_name");
const department = document.getElementById("department");
const btnSave = document.getElementById("btnSave");
const saveMsg = document.getElementById("saveMsg");

const btnFind = document.getElementById("btnFind");
const results = document.getElementById("results");

const btnInbox = document.getElementById("btnInbox");
const inbox = document.getElementById("inbox");

const chatSection = document.getElementById("chatSection");
const chatTitle = document.getElementById("chatTitle");
const messagesDiv = document.getElementById("messages");
const msgInput = document.getElementById("msgInput");
const btnSend = document.getElementById("btnSend");
const chatMsg = document.getElementById("chatMsg");

let currentUser = null;
let currentProfile = null;
let currentChatId = null;
let otherUid = null;
let unsub = null;

function pairKey(a,b){ return a<b?`${a}_${b}`:`${b}_${a}`; }

btnLogin.onclick = async()=>{
  try{ await signInWithEmailAndPassword(auth,email.value,password.value); }
  catch(e){ authMsg.textContent=e.message; }
};
btnSignup.onclick = async()=>{
  try{ await createUserWithEmailAndPassword(auth,email.value,password.value); }
  catch(e){ authMsg.textContent=e.message; }
};
btnLogout.onclick = ()=>signOut(auth);

onAuthStateChanged(auth, async(u)=>{
  currentUser=u;
  if(!u){ authView.classList.remove("hidden"); appView.classList.add("hidden"); return;}
  authView.classList.add("hidden"); appView.classList.remove("hidden");
  userLine.textContent=u.email+" | "+u.uid;
  const snap=await getDoc(doc(db,"profiles",u.uid));
  if(snap.exists()){ currentProfile=snap.data();
    display_name.value=currentProfile.display_name||"";
    department.value=currentProfile.department||"";
  }
  loadInbox();
});

btnSave.onclick = async()=>{
  const data={display_name:display_name.value,department:department.value,is_active:true,updated_at:serverTimestamp()};
  await setDoc(doc(db,"profiles",currentUser.uid),data,{merge:true});
  saveMsg.textContent="Profil enregistré";
};

btnFind.onclick = async()=>{
  results.innerHTML="";
  const q=query(collection(db,"profiles"),where("is_active","==",true));
  const snap=await getDocs(q);
  snap.forEach(d=>{
    if(d.id===currentUser.uid) return;
    const p=d.data();
    if(p.department!==department.value) return;
    const b=document.createElement("button");
    b.textContent="Contacter "+p.display_name;
    b.onclick=()=>openChat(d.id,p.display_name);
    results.appendChild(b);
  });
};

async function loadInbox(){
  inbox.innerHTML="";
  const q=query(collection(db,"messages"),
    where("participants","array-contains",currentUser.uid),
    orderBy("created_at_ms","desc"),
    limit(50));
  const snap=await getDocs(q);
  const seen=new Set();
  snap.forEach(d=>{
    const m=d.data();
    if(seen.has(m.pair_key)) return;
    seen.add(m.pair_key);
    const o=m.sender_id===currentUser.uid?m.recipient_id:m.sender_id;
    const b=document.createElement("button");
    b.textContent="Chat "+o;
    b.onclick=()=>openChat(o,"Joueur",m.pair_key);
    inbox.appendChild(b);
  });
}
btnInbox.onclick=loadInbox;

async function openChat(uid,name,forced){
  if(unsub) unsub();
  otherUid=uid;
  currentChatId=forced||pairKey(currentUser.uid,uid);
  chatTitle.textContent="Chat avec "+name;
  chatSection.classList.remove("hidden");
  messagesDiv.innerHTML="Chargement...";
  const q=query(collection(db,"messages"),
    where("participants","array-contains",currentUser.uid),
    where("pair_key","==",currentChatId),
    orderBy("created_at_ms","asc"));
  unsub=onSnapshot(q,(snap)=>{
    messagesDiv.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg "+(m.sender_id===currentUser.uid?"me":"them");
      div.textContent=m.content;
      messagesDiv.appendChild(div);
    });
  },e=>chatMsg.textContent=e.message);
}

btnSend.onclick = async()=>{
  const t=msgInput.value.trim();
  if(!t) return;
  await addDoc(collection(db,"messages"),{
    pair_key:currentChatId,
    participants:[currentUser.uid,otherUid],
    sender_id:currentUser.uid,
    recipient_id:otherUid,
    content:t,
    created_at_ms:Date.now()
  });
  msgInput.value="";
};
</script>
</body>
</html>
