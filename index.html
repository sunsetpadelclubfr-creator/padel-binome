<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Padel Binôme</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui;margin:14px}
    .card{max-width:980px;margin:0 auto;border:1px solid #ddd;border-radius:14px;padding:14px}
    input,button,textarea{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:10px}
    button{cursor:pointer}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    .hidden{display:none}
    .muted{color:#666;font-size:14px}
    .box{border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0}
    #msgs{height:340px;overflow:auto;border:1px solid #eee;border-radius:12px;padding:10px;background:#fafafa}
    .msg{max-width:75%;padding:8px 10px;border-radius:12px;margin:6px 0;white-space:pre-wrap}
    .me{margin-left:auto;background:#e8f5ff}
    .them{margin-right:auto;background:#f1f1f1}
    pre{white-space:pre-wrap;background:#111;color:#eee;padding:10px;border-radius:10px;overflow:auto}
  </style>
</head>
<body>

<div class="card">
  <h2>Padel Binôme</h2>

  <!-- AUTH -->
  <div id="authView" class="box">
    <h3>Connexion / Inscription</h3>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Mot de passe (min 6)">
    <div class="row">
      <button id="btnLogin" type="button">Se connecter</button>
      <button id="btnSignup" type="button">Créer un compte</button>
    </div>
    <p id="authMsg" class="muted"></p>
    <details>
      <summary>Debug</summary>
      <pre id="debug"></pre>
    </details>
  </div>

  <!-- APP -->
  <div id="appView" class="hidden">
    <div class="row">
      <div><p id="userLine" class="muted"></p></div>
      <div><button id="btnLogout" type="button">Se déconnecter</button></div>
    </div>

    <h3>Mon profil</h3>
    <div class="box">
      <input id="display_name" placeholder="Pseudo / Prénom">
      <input id="department" placeholder="Département (ex: 75)">
      <div class="row">
        <button id="btnSave" type="button">Enregistrer</button>
        <button id="btnActive" type="button">Visible / Invisible</button>
      </div>
      <p id="saveMsg" class="muted"></p>
    </div>

    <h3>Trouver un binôme (même département)</h3>
    <div class="box">
      <button id="btnFind" type="button">Rechercher</button>
      <div id="results"></div>
    </div>

    <h3>Mes conversations</h3>
    <div class="box">
      <button id="btnInbox" type="button">Rafraîchir</button>
      <div id="inbox"></div>
      <p id="inboxMsg" class="muted"></p>
    </div>

    <!-- CHAT -->
    <div id="chatBox" class="box hidden">
      <div class="row">
        <div>
          <strong id="chatTitle">Chat</strong><br>
          <span id="chatInfo" class="muted"></span>
        </div>
        <div><button id="btnCloseChat" type="button">Fermer</button></div>
      </div>

      <div id="msgs">—</div>

      <div class="row" style="margin-top:8px">
        <textarea id="msgInput" rows="2" placeholder="Ton message..."></textarea>
        <button id="btnSend" type="button">Envoyer</button>
      </div>
      <p id="chatMsg" class="muted"></p>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  doc, getDoc, setDoc, updateDoc, serverTimestamp,
  collection, addDoc, getDocs, query, where, orderBy, limit, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* =========================
   Firebase config
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAN3k8oOsG_42wRmmkdHqKs7XjIamNiVy4",
  authDomain: "padel-binome.firebaseapp.com",
  projectId: "padel-binome",
  storageBucket: "padel-binome.firebasestorage.app",
  messagingSenderId: "968501656511",
  appId: "1:968501656511:web:464dca20866e202d53ff0a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* =========================
   UI refs
========================= */
const authView = document.getElementById("authView");
const appView  = document.getElementById("appView");
const authMsg  = document.getElementById("authMsg");
const debugEl  = document.getElementById("debug");

const emailEl = document.getElementById("email");
const passEl  = document.getElementById("password");
const btnLogin  = document.getElementById("btnLogin");
const btnSignup = document.getElementById("btnSignup");
const btnLogout = document.getElementById("btnLogout");
const userLine  = document.getElementById("userLine");

const displayNameEl = document.getElementById("display_name");
const departmentEl  = document.getElementById("department");
const btnSave   = document.getElementById("btnSave");
const btnActive = document.getElementById("btnActive");
const saveMsg   = document.getElementById("saveMsg");

const btnFind  = document.getElementById("btnFind");
const results  = document.getElementById("results");

const btnInbox = document.getElementById("btnInbox");
const inbox    = document.getElementById("inbox");
const inboxMsg = document.getElementById("inboxMsg");

const chatBox   = document.getElementById("chatBox");
const chatTitle = document.getElementById("chatTitle");
const chatInfo  = document.getElementById("chatInfo");
const btnCloseChat = document.getElementById("btnCloseChat");
const msgsDiv   = document.getElementById("msgs");
const msgInput  = document.getElementById("msgInput");
const btnSend   = document.getElementById("btnSend");
const chatMsg   = document.getElementById("chatMsg");

/* =========================
   State
========================= */
let currentUser = null;
let currentProfile = null;

let currentChatId = null;
let otherUid = null;
let otherName = null;
let unsubMsgs = null;

/* =========================
   Helpers
========================= */
function logDebug(title, obj){
  debugEl.textContent = `[${new Date().toISOString()}] ${title}\n` +
    (obj ? JSON.stringify(obj, Object.getOwnPropertyNames(obj), 2) : "");
  console.log(title, obj);
}
window.addEventListener("error", (e)=>{ authMsg.textContent="Erreur JS: "+e.message; logDebug("window.error", e); });
window.addEventListener("unhandledrejection", (e)=>{ authMsg.textContent="Promise: "+(e.reason?.message||e.reason); logDebug("unhandledrejection", e.reason); });

function pairKey(a,b){ return (a<b) ? `${a}_${b}` : `${b}_${a}`; }

function renderMessage(m){
  const div = document.createElement("div");
  div.className = "msg " + (m.sender_id === currentUser.uid ? "me" : "them");
  div.textContent = m.content || "";
  return div;
}

/* =========================
   AUTH
========================= */
btnLogin.addEventListener("click", async (e)=>{
  e.preventDefault();
  authMsg.textContent = "Connexion...";
  try{
    await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
    authMsg.textContent = "";
  }catch(err){
    authMsg.textContent = "Erreur login: " + (err?.message || err);
    logDebug("login.error", err);
  }
});

btnSignup.addEventListener("click", async (e)=>{
  e.preventDefault();
  authMsg.textContent = "Création...";
  try{
    await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
    authMsg.textContent = "";
  }catch(err){
    authMsg.textContent = "Erreur signup: " + (err?.message || err);
    logDebug("signup.error", err);
  }
});

btnLogout.addEventListener("click", ()=>signOut(auth));

/* =========================
   Profile
========================= */
async function loadProfile(uid){
  const snap = await getDoc(doc(db,"profiles",uid));
  if(!snap.exists()) return null;
  const p = snap.data();
  displayNameEl.value = p.display_name || "";
  departmentEl.value  = p.department || "";
  return p;
}

btnSave.addEventListener("click", async ()=>{
  if(!currentUser) return;
  const display_name = displayNameEl.value.trim();
  const department = departmentEl.value.trim();
  if(!display_name || !department){
    saveMsg.textContent = "Pseudo + département requis.";
    return;
  }
  saveMsg.textContent = "Enregistrement...";
  await setDoc(doc(db,"profiles", currentUser.uid), {
    display_name,
    department,
    is_active: currentProfile?.is_active ?? true,
    updated_at: serverTimestamp(),
    created_at: currentProfile?.created_at ?? serverTimestamp()
  }, { merge:true });

  currentProfile = await loadProfile(currentUser.uid);
  saveMsg.textContent = "Profil enregistré ✅";
});

btnActive.addEventListener("click", async ()=>{
  if(!currentUser) return;
  const next = !(currentProfile?.is_active ?? true);
  await setDoc(doc(db,"profiles", currentUser.uid), {
    is_active: next,
    updated_at: serverTimestamp()
  }, { merge:true });

  currentProfile = await loadProfile(currentUser.uid);
  saveMsg.textContent = next ? "Visible ✅" : "Invisible ✅";
});

/* =========================
   Matching (même département)
========================= */
btnFind.addEventListener("click", async ()=>{
  results.innerHTML = "Recherche...";
  if(!currentProfile?.department){
    results.innerHTML = "<p class='muted'>Complète ton département.</p>";
    return;
  }
  const q = query(collection(db,"profiles"), where("is_active","==",true));
  const snap = await getDocs(q);

  let html = "";
  snap.forEach(d=>{
    if(d.id === currentUser.uid) return;
    const p = d.data();
    if((p.department||"") !== currentProfile.department) return;

    html += `
      <div class="box" style="margin:8px 0">
        <strong>${p.display_name||"Joueur"}</strong> — ${p.department}<br>
        <button class="btnContact" type="button"
          data-uid="${d.id}"
          data-name="${encodeURIComponent(p.display_name||"Joueur")}">Contacter</button>
      </div>
    `;
  });

  results.innerHTML = html || "<p class='muted'>Aucun résultat.</p>";

  document.querySelectorAll(".btnContact").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const uid = btn.dataset.uid;
      const name = decodeURIComponent(btn.dataset.name || "Joueur");
      await openChat(uid, name);
    });
  });
});

/* =========================
   Ensure chat exists
========================= */
async function ensureChatDoc(chatId, uidA, uidB){
  // On écrit directement (merge) sans "get" préalable
  await setDoc(doc(db,"chats",chatId), {
    participants: [uidA, uidB],
    created_at_ms: Date.now(),
    last_message_at_ms: 0,
    last_message_preview: "",
    last_message_sender: ""
  }, { merge: true });
}

/* =========================
   Inbox = list chats
========================= */
async function loadInbox(){
  inboxMsg.textContent = "";
  inbox.innerHTML = "Chargement...";

  try{
    const qInbox = query(
      collection(db, "inbox", currentUser.uid, "chats"),
      orderBy("last_message_at_ms", "desc"),
      limit(50)
    );
    const snap = await getDocs(qInbox);

    if(snap.empty){
      inbox.innerHTML = "<p class='muted'>Aucune conversation.</p>";
      return;
    }

    // cache noms
    const nameCache = new Map();
    async function getName(uid){
      if(nameCache.has(uid)) return nameCache.get(uid);
      try{
        const ps = await getDoc(doc(db,"profiles",uid));
        const nm = ps.exists() ? (ps.data().display_name || uid) : uid;
        nameCache.set(uid, nm);
        return nm;
      }catch{ return uid; }
    }

    inbox.innerHTML = "";
    for(const d of snap.docs){
      const c = d.data();      // { other_uid, last_message_preview, last_message_at_ms }
      const chatId = d.id;
      const ouid = c.other_uid;
      const oname = await getName(ouid);

      const box = document.createElement("div");
      box.className = "box";
      box.innerHTML = `
        <strong>${oname}</strong><br>
        <span class="muted">${(c.last_message_preview||"").slice(0,120)}</span><br>
      `;
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = "Ouvrir";
      b.onclick = ()=>openChat(ouid, oname, chatId);
      box.appendChild(b);
      inbox.appendChild(box);
    }

  }catch(err){
    inbox.innerHTML = "<p class='muted'>Inbox indisponible.</p>";
    inboxMsg.textContent = "Erreur inbox: " + (err?.message || err) + " | code=" + (err?.code||"");
    logDebug("inbox.error", err);
  }
}


    inbox.innerHTML = "";
    for(const d of snap.docs){
      const c = d.data();
      const chatId = d.id;
      const parts = c.participants || [];
      const ouid = (parts[0] === currentUser.uid) ? parts[1] : parts[0];
      const oname = await getName(ouid);

      const box = document.createElement("div");
      box.className = "box";
      box.innerHTML = `
        <strong>${oname}</strong><br>
        <span class="muted">${(c.last_message_preview||"").slice(0,120)}</span><br>
      `;
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = "Ouvrir";
      b.onclick = ()=>openChat(ouid, oname, chatId);
      box.appendChild(b);
      inbox.appendChild(box);
    }

  }catch(err){
    inbox.innerHTML = "<p class='muted'>Inbox indisponible.</p>";
    inboxMsg.textContent = "Erreur inbox: " + (err?.message || err) + " | code=" + (err?.code||"");
    logDebug("inbox.error", err);
  }
}

btnInbox.addEventListener("click", loadInbox);

/* =========================
   Chat
========================= */
async function openChat(uid, name, forcedChatId=null){
  if(unsubMsgs) unsubMsgs();
  unsubMsgs = null;

  otherUid = uid;
  otherName = name;

  currentChatId = forcedChatId || pairKey(currentUser.uid, uid);

  chatBox.classList.remove("hidden");
  chatTitle.textContent = "Chat avec " + (name || "Joueur");
  chatInfo.textContent = "chatId: " + currentChatId;
  chatMsg.textContent = "";
  msgsDiv.innerHTML = "Chargement...";

  // ensure chat doc
  await ensureChatDoc(currentChatId, currentUser.uid, uid);

  // listen messages
  const qMsgs = query(
    collection(db, "chats", currentChatId, "messages"),
    orderBy("created_at_ms","asc"),
    limit(200)
  );

  unsubMsgs = onSnapshot(qMsgs, (snap)=>{
    msgsDiv.innerHTML = "";
    if(snap.empty){
      msgsDiv.innerHTML = "<span class='muted'>Aucun message.</span>";
      return;
    }
    snap.forEach(d=>msgsDiv.appendChild(renderMessage(d.data())));
    msgsDiv.scrollTop = msgsDiv.scrollHeight;
  }, (err)=>{
    chatMsg.textContent = "Erreur chat: " + (err?.message || err) + " | code=" + (err?.code||"");
    logDebug("chat.listen.error", err);
  });
}

btnCloseChat.addEventListener("click", ()=>{
  chatBox.classList.add("hidden");
  msgsDiv.innerHTML = "";
  chatMsg.textContent = "";
  currentChatId = null;
  otherUid = null;
  otherName = null;
  if(unsubMsgs) unsubMsgs();
  unsubMsgs = null;
});

/* =========================
   ✅ Envoi STEP0/STEP1/STEP2 (correction)
========================= */
btnSend.addEventListener("click", async ()=>{
  const text = msgInput.value.trim();
  if(!text || !currentChatId || !otherUid) return;

  btnSend.disabled = true;
  chatMsg.textContent = "";

  const chatRef = doc(db, "chats", currentChatId);
  const msgsRef = collection(db, "chats", currentChatId, "messages");

  // STEP 0: s'assurer que le chat existe
  try{
    await ensureChatDoc(currentChatId, currentUser.uid, otherUid);
  }catch(e0){
    chatMsg.textContent = "Erreur STEP0 (ensureChatDoc): " + (e0?.message || e0) + " | code=" + (e0?.code||"");
    logDebug("STEP0 error", e0);
    btnSend.disabled = false;
    return;
  }

  // STEP 1: envoyer le message
  try{
    await addDoc(msgsRef, {
      sender_id: currentUser.uid,
      content: text,
      created_at_ms: Date.now()
    });
  }catch(e1){
    chatMsg.textContent = "Erreur STEP1 (addDoc message): " + (e1?.message || e1) + " | code=" + (e1?.code||"");
    logDebug("STEP1 error", e1);
    btnSend.disabled = false;
    return;
  }

  // STEP 2: update meta chat + inbox des 2 utilisateurs
try{
  const now = Date.now();
  const preview = text.slice(0,120);

  // update chat meta
  await updateDoc(doc(db, "chats", currentChatId), {
    last_message_at_ms: now,
    last_message_preview: preview,
    last_message_sender: currentUser.uid
  });

  // update inbox pour moi
  await setDoc(doc(db, "inbox", currentUser.uid, "chats", currentChatId), {
    other_uid: otherUid,
    last_message_at_ms: now,
    last_message_preview: preview
  }, { merge: true });

  // update inbox pour l'autre
  await setDoc(doc(db, "inbox", otherUid, "chats", currentChatId), {
    other_uid: currentUser.uid,
    last_message_at_ms: now,
    last_message_preview: preview
  }, { merge: true });

}catch(e2){
  chatMsg.textContent =
    "Message envoyé ✅ mais erreur STEP2 (meta/inbox): " +
    (e2?.message || e2) + " | code=" + (e2?.code||"");
  logDebug("STEP2 error", e2);
}


  msgInput.value = "";
  await loadInbox();
  btnSend.disabled = false;
});

/* =========================
   Auth state
========================= */
onAuthStateChanged(auth, async (u)=>{
  currentUser = u;

  if(!u){
    appView.classList.add("hidden");
    authView.classList.remove("hidden");
    chatBox.classList.add("hidden");
    return;
  }

  authView.classList.add("hidden");
  appView.classList.remove("hidden");
  userLine.textContent = `Connecté: ${u.email} | uid=${u.uid} | projectId=${app.options.projectId}`;

  currentProfile = await loadProfile(u.uid);
  await loadInbox();
});
</script>

</body>
</html>
