<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Padel Binôme</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui;margin:14px}
    .card{max-width:980px;margin:0 auto;border:1px solid #ddd;border-radius:14px;padding:14px}
    input,button,textarea,select{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:10px}
    button{cursor:pointer}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    .hidden{display:none}
    .muted{color:#666;font-size:14px}
    .box{border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0}
    #msgs{height:340px;overflow:auto;border:1px solid #eee;border-radius:12px;padding:10px;background:#fafafa}
    .msg{max-width:75%;padding:8px 10px;border-radius:12px;margin:6px 0;white-space:pre-wrap}
    .me{margin-left:auto;background:#e8f5ff}
    .them{margin-right:auto;background:#f1f1f1}
    pre{white-space:pre-wrap;background:#111;color:#eee;padding:10px;border-radius:10px;overflow:auto}

    /* Sunset clair */
    .sunset {
      background: linear-gradient(180deg, #fff7ed 0%, #fff1f2 55%, #eef2ff 120%);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
    }
    .sunset .hint { color:#6b7280; font-size:14px; margin-top:-2px; }
    .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:700px){ .grid2{ grid-template-columns:1fr; } }
    .badge {
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.75);
      font-size:12px;
      color:#374151;
    }
    .matchCard{
      border:1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.75);
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0;
    }
    .matchRow{
      display:flex; justify-content:space-between; gap:10px; align-items:center;
    }
    .matchScore{ font-weight:700; }
    .small{ font-size:13px; color:#6b7280; }
    .chip{
      display:inline-flex; align-items:center; gap:10px;
      border:1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.75);
      padding:8px 10px;
      border-radius: 999px;
      margin: 6px 0;
    }
    .chip input{ width:auto; margin:0; }
  </style>
</head>
<body>

<div class="card">
  <h2>Padel Binôme</h2>

  <!-- AUTH -->
  <div id="authView" class="box">
    <h3>Connexion / Inscription</h3>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Mot de passe (min 6)">
    <div class="row">
      <button id="btnLogin" type="button">Se connecter</button>
      <button id="btnSignup" type="button">Créer un compte</button>
    </div>
    <p id="authMsg" class="muted"></p>
    <details>
      <summary>Debug</summary>
      <pre id="debug"></pre>
    </details>
  </div>

  <!-- APP -->
  <div id="appView" class="hidden">
    <div class="row">
      <div><p id="userLine" class="muted"></p></div>
      <div><button id="btnLogout" type="button">Se déconnecter</button></div>
    </div>

    <h3>Mon profil</h3>
    <div class="box">
      <label><strong>Nom / Pseudo</strong></label>
<input id="display_name" placeholder="Ex: Alex / SunsetPadel">

<div class="row">
  <div>
    <label><strong>Département</strong></label>
    <input id="department" placeholder="Ex: 75 ou 2A">
  </div>

  <div>
    <label><strong>Club Padel</strong></label>
    <input id="club" placeholder="Ex: Sunset Padel Club">
  </div>
</div>
      </div>
      <div class="row">
        <button id="btnSave" type="button">Enregistrer</button>
        <button id="btnActive" type="button">Visible / Invisible</button>
      </div>
      <p id="saveMsg" class="muted"></p>
    </div>

    <h3>Questionnaire Padel (matching)</h3>
    <div class="sunset" id="qaBox">
      <div class="hint">12 questions rapides pour trouver un binôme compatible.</div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <label><strong>1) Vous êtes ?</strong></label>
          <select id="q_gender">
            <option value="H">Homme</option>
            <option value="F">Femme</option>
          </select>
        </div>

        <div>
          <label><strong>2) Vous recherchez ?</strong></label>
          <select id="q_search">
            <option value="same">Même catégorie</option>
            <option value="mix">Mixte</option>
          </select>
          <div class="small" id="searchHint"></div>
        </div>

        <div>
          <label class="chip">
            <input id="q_neighbors" type="checkbox">
            <span><strong>Inclure les départements voisins</strong></span>
          </label>
          <div class="small" id="neighborsHint"></div>
        </div>

        <div>
          <label class="chip">
            <input id="q_clubOnly" type="checkbox">
            <span><strong>Filtrer par mon club</strong></span>
          </label>
          <div class="small" id="clubHint"></div>
        </div>

        <div>
          <label><strong>3) Niveau (1–10)</strong> <span class="badge" id="lvlBadge">5</span></label>
          <input id="q_level" type="range" min="1" max="10" step="1" value="5">
          <div class="small">1 = débutant · 10 = très avancé</div>
        </div>

        <div>
          <label><strong>4) Main dominante</strong></label>
          <select id="q_hand">
            <option value="R">Droitier</option>
            <option value="L">Gaucher</option>
          </select>
        </div>

        <div>
          <label><strong>5) Poste préféré</strong></label>
          <select id="q_side">
            <option value="left">Gauche</option>
            <option value="right">Droite</option>
            <option value="any">Indifférent</option>
          </select>
        </div>

        <div>
          <label><strong>6) Style principal</strong></label>
          <select id="q_style">
            <option value="atk">Attaquant</option>
            <option value="def">Défenseur</option>
            <option value="bal">Polyvalent</option>
          </select>
        </div>

        <div>
          <label><strong>7) Communication</strong></label>
          <select id="q_comms">
            <option value="calm">Calme</option>
            <option value="norm">Normal</option>
            <option value="vocal">Très vocal</option>
          </select>
        </div>

        <div>
          <label><strong>8) Mental</strong></label>
          <select id="q_mental">
            <option value="chill">Chill</option>
            <option value="comp">Compétiteur</option>
            <option value="hard">Très compétiteur</option>
          </select>
        </div>

        <div>
          <label><strong>9) Tolérance à l’erreur</strong></label>
          <select id="q_tolerance">
            <option value="patient">Patience</option>
            <option value="norm">Normal</option>
            <option value="strict">Exigeant</option>
          </select>
        </div>

        <div>
          <label><strong>10) Objectif</strong></label>
          <select id="q_goal">
            <option value="fun">Loisir</option>
            <option value="progress">Progression</option>
            <option value="tourney">Tournois</option>
          </select>
        </div>

        <div>
          <label><strong>11) Fréquence</strong></label>
          <select id="q_freq">
            <option value="1">1x/sem</option>
            <option value="2">2x/sem</option>
            <option value="3">3x+/sem</option>
            <option value="v">Variable</option>
          </select>
        </div>

        <div>
          <label><strong>12) Disponibilités</strong></label>
          <select id="q_avail">
            <option value="week">Semaine</option>
            <option value="end">Week-end</option>
            <option value="both">Les deux</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnSaveQA" type="button">Enregistrer mon questionnaire</button>
        <button id="btnFindMatches" type="button">Trouver mon binôme</button>
      </div>

      <p class="muted" id="qaMsg"></p>
    </div>

    <div id="matchResults"></div>

    <h3>Mes conversations</h3>
    <div class="box">
      <button id="btnInbox" type="button">Rafraîchir</button>
      <div id="inbox"></div>
      <p id="inboxMsg" class="muted"></p>
    </div>

    <!-- CHAT -->
    <div id="chatBox" class="box hidden">
      <div class="row">
        <div>
          <strong id="chatTitle">Chat</strong><br>
          <span id="chatInfo" class="muted"></span>
        </div>
        <div><button id="btnCloseChat" type="button">Fermer</button></div>
      </div>

      <div id="msgs">—</div>

      <div class="row" style="margin-top:8px">
        <textarea id="msgInput" rows="2" placeholder="Ton message..."></textarea>
        <button id="btnSend" type="button">Envoyer</button>
      </div>
      <p id="chatMsg" class="muted"></p>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,
  doc, getDoc, setDoc, updateDoc, serverTimestamp,
  collection, addDoc, getDocs, query, where, orderBy, limit, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* =========================
   Firebase config
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAN3k8oOsG_42wRmmkdHqKs7XjIamNiVy4",
  authDomain: "padel-binome.firebaseapp.com",
  projectId: "padel-binome",
  storageBucket: "padel-binome.firebasestorage.app",
  messagingSenderId: "968501656511",
  appId: "1:968501656511:web:464dca20866e202d53ff0a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* =========================
   UI refs
========================= */
const authView = document.getElementById("authView");
const appView  = document.getElementById("appView");
const authMsg  = document.getElementById("authMsg");
const debugEl  = document.getElementById("debug");

const emailEl = document.getElementById("email");
const passEl  = document.getElementById("password");
const btnLogin  = document.getElementById("btnLogin");
const btnSignup = document.getElementById("btnSignup");
const btnLogout = document.getElementById("btnLogout");
const userLine  = document.getElementById("userLine");

const displayNameEl = document.getElementById("display_name");
const departmentEl  = document.getElementById("department");
const clubEl        = document.getElementById("club");
const btnSave   = document.getElementById("btnSave");
const btnActive = document.getElementById("btnActive");
const saveMsg   = document.getElementById("saveMsg");

const btnInbox = document.getElementById("btnInbox");
const inbox    = document.getElementById("inbox");
const inboxMsg = document.getElementById("inboxMsg");

const chatBox   = document.getElementById("chatBox");
const chatTitle = document.getElementById("chatTitle");
const chatInfo  = document.getElementById("chatInfo");
const btnCloseChat = document.getElementById("btnCloseChat");
const msgsDiv   = document.getElementById("msgs");
const msgInput  = document.getElementById("msgInput");
const btnSend   = document.getElementById("btnSend");
const chatMsg   = document.getElementById("chatMsg");

/* Questionnaire refs */
const q_gender = document.getElementById("q_gender");
const q_search = document.getElementById("q_search");
const q_neighbors = document.getElementById("q_neighbors");
const q_clubOnly = document.getElementById("q_clubOnly");
const q_level  = document.getElementById("q_level");
const lvlBadge = document.getElementById("lvlBadge");
const q_hand = document.getElementById("q_hand");
const q_side = document.getElementById("q_side");
const q_style = document.getElementById("q_style");
const q_comms = document.getElementById("q_comms");
const q_mental = document.getElementById("q_mental");
const q_tolerance = document.getElementById("q_tolerance");
const q_goal = document.getElementById("q_goal");
const q_freq = document.getElementById("q_freq");
const q_avail = document.getElementById("q_avail");
const searchHint = document.getElementById("searchHint");
const neighborsHint = document.getElementById("neighborsHint");
const clubHint = document.getElementById("clubHint");
const btnSaveQA = document.getElementById("btnSaveQA");
const btnFindMatches = document.getElementById("btnFindMatches");
const qaMsg = document.getElementById("qaMsg");
const matchResults = document.getElementById("matchResults");

/* =========================
   State
========================= */
let currentUser = null;
let currentProfile = null;
let currentChatId = null;
let otherUid = null;
let otherName = null;
let unsubMsgs = null;

/* =========================
   Helpers
========================= */
function logDebug(title, obj){
  debugEl.textContent = `[${new Date().toISOString()}] ${title}\n` +
    (obj ? JSON.stringify(obj, Object.getOwnPropertyNames(obj), 2) : "");
  console.log(title, obj);
}
window.addEventListener("error", (e)=>{ authMsg.textContent="Erreur JS: "+e.message; logDebug("window.error", e); });
window.addEventListener("unhandledrejection", (e)=>{ authMsg.textContent="Promise: "+(e.reason?.message||e.reason); logDebug("unhandledrejection", e.reason); });

function pairKey(a,b){ return (a<b) ? `${a}_${b}` : `${b}_${a}`; }

function renderMessage(m){
  const div = document.createElement("div");
  div.className = "msg " + (m.sender_id === currentUser.uid ? "me" : "them");
  div.textContent = m.content || "";
  return div;
}

function normalizeClub(s){
  return (s || "").trim().toLowerCase();
}

/* =========================
   Départements voisins
========================= */
const DEP_NEIGHBORS = {
  "01":["38","39","69","71","73","74"],
  "02":["08","51","59","60","77","80"],
  "03":["18","23","42","58","63","71"],
  "04":["05","06","26","83","84"],
  "05":["04","26","38","73"],
  "06":["04","83"],
  "07":["26","30","38","42","43","48","84"],
  "08":["02","51","55"],
  "09":["11","31","66"],
  "10":["21","51","52","77","89"],
  "11":["09","31","34","66","81"],
  "12":["15","30","34","46","48","81","82"],
  "13":["30","83","84"],
  "14":["27","50","61","76"],
  "15":["12","19","43","46","48","63"],
  "16":["17","24","79","86","87"],
  "17":["16","24","33","79","85"],
  "18":["03","23","36","41","45","58"],
  "19":["15","23","24","46","63","87"],
  "2A":["2B"],
  "2B":["2A"],
  "21":["10","39","52","58","70","71","89"],
  "22":["29","35","56"],
  "23":["03","18","19","36","63","87"],
  "24":["16","17","19","33","46","47","87"],
  "25":["39","70","90"],
  "26":["04","05","07","38","84"],
  "27":["14","28","60","61","76","78","95"],
  "28":["27","41","45","61","72","78","91"],
  "29":["22","56"],
  "30":["07","12","13","34","48","84"],
  "31":["09","11","32","65","81","82"],
  "32":["31","40","47","64","65","82"],
  "33":["17","24","40","47"],
  "34":["11","12","30","81"],
  "35":["22","44","49","50","53","56"],
  "36":["18","23","37","41","86","87"],
  "37":["36","41","49","72","86"],
  "38":["01","05","07","26","42","69","73"],
  "39":["01","21","25","70","71"],
  "40":["32","33","47","64"],
  "41":["18","28","36","37","45","72"],
  "42":["03","07","38","43","63","69","71"],
  "43":["07","15","42","48","63"],
  "44":["35","49","56","85"],
  "45":["18","28","41","58","77","89","91"],
  "46":["12","15","19","24","47","82"],
  "47":["24","32","33","40","46","82"],
  "48":["07","12","15","30","43"],
  "49":["35","37","44","53","72","79","85","86"],
  "50":["14","35","53","61"],
  "51":["02","08","10","52","55","77"],
  "52":["10","21","51","55","70","88"],
  "53":["35","49","50","61","72"],
  "54":["55","57","67","88"],
  "55":["08","51","52","54","88"],
  "56":["22","29","35","44"],
  "57":["54","67"],
  "58":["03","18","21","45","71","89"],
  "59":["02","62","80"],
  "60":["02","27","76","77","80","95"],
  "61":["14","27","28","50","53","72"],
  "62":["59","80"],
  "63":["03","15","19","23","42","43"],
  "64":["32","40","65"],
  "65":["31","32","64"],
  "66":["09","11"],
  "67":["54","57","68","88"],
  "68":["67","88","90"],
  "69":["01","38","42","71"],
  "70":["21","25","39","52","88","90"],
  "71":["01","03","21","39","42","58","69"],
  "72":["28","37","41","49","53","61"],
  "73":["01","05","38","74"],
  "74":["01","73"],
  "75":["92","93","94"],
  "76":["14","27","60","80"],
  "77":["02","10","45","51","60","89","91","93","94","95"],
  "78":["27","28","91","92","95"],
  "79":["16","17","49","85","86"],
  "80":["02","59","60","62","76"],
  "81":["11","12","31","34","82"],
  "82":["12","31","32","46","47","81"],
  "83":["04","06","13","84"],
  "84":["04","07","13","26","30","83"],
  "85":["17","44","49","79"],
  "86":["16","36","37","49","79","87"],
  "87":["16","19","23","24","36","86"],
  "88":["52","54","55","67","68","70","90"],
  "89":["10","21","45","58","77"],
  "90":["25","68","70","88"],
  "91":["28","45","77","78","92","94"],
  "92":["75","78","91","93","94","95"],
  "93":["75","77","92","94","95"],
  "94":["75","77","91","92","93"],
  "95":["27","60","77","78","92","93"]
};

function normalizeDep(dep){
  if(!dep) return "";
  let d = String(dep).trim().toUpperCase();
  if(/^\d$/.test(d)) d = "0"+d;
  if(d === "20") d = "2A";
  return d;
}
function allowedDeps(myDep, includeNeighbors){
  const raw = String(myDep || "").trim().toUpperCase();
  const d = normalizeDep(raw);
  const set = new Set();
  if(!d) return set;
  if(raw === "20"){ set.add("2A"); set.add("2B"); return set; }
  set.add(d);
  if(includeNeighbors){ (DEP_NEIGHBORS[d] || []).forEach(x => set.add(x)); }
  return set;
}

/* =========================
   AUTH
========================= */
btnLogin.addEventListener("click", async (e)=>{
  e.preventDefault();
  authMsg.textContent = "Connexion...";
  try{
    await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
    authMsg.textContent = "";
  }catch(err){
    authMsg.textContent = "Erreur login: " + (err?.message || err);
    logDebug("login.error", err);
  }
});
btnSignup.addEventListener("click", async (e)=>{
  e.preventDefault();
  authMsg.textContent = "Création...";
  try{
    await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
    authMsg.textContent = "";
  }catch(err){
    authMsg.textContent = "Erreur signup: " + (err?.message || err);
    logDebug("signup.error", err);
  }
});
btnLogout.addEventListener("click", ()=>signOut(auth));

/* =========================
   Profil
========================= */
async function loadProfile(uid){
  const snap = await getDoc(doc(db,"profiles",uid));
  if(!snap.exists()) return null;
  const p = snap.data();
  displayNameEl.value = p.display_name || "";
  departmentEl.value  = p.department || "";
  clubEl.value        = p.club || "";
  return p;
}
btnSave.addEventListener("click", async ()=>{
  if(!currentUser) return;
  const display_name = displayNameEl.value.trim();
  const department = departmentEl.value.trim();
  const club = clubEl.value.trim();
  if(!display_name || !department){
    saveMsg.textContent = "Pseudo + département requis.";
    return;
  }
  saveMsg.textContent = "Enregistrement...";
  await setDoc(doc(db,"profiles", currentUser.uid), {
    display_name, department, club,
    is_active: currentProfile?.is_active ?? true,
    updated_at: serverTimestamp(),
    created_at: currentProfile?.created_at ?? serverTimestamp()
  }, { merge:true });

  currentProfile = await loadProfile(currentUser.uid);
  saveMsg.textContent = "Profil enregistré ✅";
  applyHints();
});
btnActive.addEventListener("click", async ()=>{
  if(!currentUser) return;
  const next = !(currentProfile?.is_active ?? true);
  await setDoc(doc(db,"profiles", currentUser.uid), { is_active: next, updated_at: serverTimestamp() }, { merge:true });
  currentProfile = await loadProfile(currentUser.uid);
  saveMsg.textContent = next ? "Visible ✅" : "Invisible ✅";
});

/* =========================
   Questionnaire
========================= */
function getQA(){
  return {
    gender: q_gender.value,
    search: q_search.value,
    neighbors: !!q_neighbors.checked,
    clubOnly: !!q_clubOnly.checked,
    level: Number(q_level.value),
    hand: q_hand.value,
    side: q_side.value,
    style: q_style.value,
    comms: q_comms.value,
    mental: q_mental.value,
    tolerance: q_tolerance.value,
    goal: q_goal.value,
    freq: q_freq.value,
    avail: q_avail.value
  };
}
function applyHints(){
  if(q_search.value === "same"){
    searchHint.textContent = (q_gender.value === "H") ? "Tu verras uniquement des hommes." : "Tu verras uniquement des femmes.";
  } else {
    searchHint.textContent = "Tu verras hommes + femmes (mixte).";
  }

  const dep = currentProfile?.department || departmentEl.value.trim();
  const depSet = allowedDeps(dep, q_neighbors.checked);
  neighborsHint.textContent = dep
    ? `Zone: ${normalizeDep(dep)}${q_neighbors.checked ? " + voisins" : ""} (≈ ${depSet.size} départements)`
    : "Renseigne ton département dans le profil.";

  const club = currentProfile?.club || clubEl.value.trim();
  clubHint.textContent = club
    ? `Club: “${club}”${q_clubOnly.checked ? " (filtre activé)" : ""}`
    : "Aucun club enregistré (le filtre club ne pourra pas s’appliquer).";
}
q_gender.addEventListener("change", applyHints);
q_search.addEventListener("change", applyHints);
q_neighbors.addEventListener("change", applyHints);
q_clubOnly.addEventListener("change", applyHints);
q_level.addEventListener("input", ()=>{ lvlBadge.textContent = String(q_level.value); });

btnSaveQA.addEventListener("click", async ()=>{
  if(!currentUser) return;
  qaMsg.textContent = "Enregistrement questionnaire...";
  try{
    const qa = getQA();
    await setDoc(doc(db, "profiles", currentUser.uid), { qa, updated_at: serverTimestamp(), is_active: currentProfile?.is_active ?? true }, { merge:true });
    currentProfile = await (async ()=>{
      const snap = await getDoc(doc(db,"profiles", currentUser.uid));
      return snap.exists() ? snap.data() : currentProfile;
    })();
    qaMsg.textContent = "Questionnaire enregistré ✅";
    applyHints();
  }catch(e){
    qaMsg.textContent = "Erreur enregistrement: " + (e?.message || e);
    console.log("saveQA error", e);
  }
});

/* =========================
   Filtres / Score
========================= */
function isGenderAllowed(meQA, otherQA){
  if(!otherQA?.gender) return true;
  if(meQA.search === "mix") return true;
  return otherQA.gender === meQA.gender;
}
function compatibilityScore(meQA, otherQA){
  if(!otherQA) return 0;
  let score = 0, max = 0;

  max += 25;
  const d = Math.abs((meQA.level||0) - (otherQA.level||0));
  score += (d===0?25:d===1?20:d===2?15:d===3?8:0);

  max += 12;
  const a = meQA.side, b = otherQA.side;
  if(a === "any" || b === "any") score += 8;
  else if(a !== b) score += 12;
  else score += 3;

  max += 12;
  const s1 = meQA.style, s2 = otherQA.style;
  if(s1 === "bal" || s2 === "bal") score += 10;
  else if((s1==="atk" && s2==="def") || (s1==="def" && s2==="atk")) score += 12;
  else score += 6;

  max += 10;
  score += (meQA.goal === otherQA.goal) ? 10 : 4;

  max += 8;
  score += (meQA.freq === "v" || otherQA.freq === "v") ? 5 : (meQA.freq === otherQA.freq ? 8 : 4);

  max += 10;
  const av1 = meQA.avail, av2 = otherQA.avail;
  score += (av1 === "both" || av2 === "both" || av1 === av2) ? 10 : 2;

  max += 8;
  score += (meQA.comms === otherQA.comms) ? 8 : 4;

  max += 8;
  score += (meQA.mental === otherQA.mental) ? 8 : 4;

  max += 7;
  score += (meQA.tolerance === otherQA.tolerance) ? 7 : 3;

  max += 5;
  score += (meQA.hand !== otherQA.hand) ? 5 : 3;

  return Math.round((score / max) * 100);
}

btnFindMatches.addEventListener("click", async ()=>{
  matchResults.innerHTML = "";
  qaMsg.textContent = "";

  if(!currentUser){ qaMsg.textContent = "Connecte-toi d’abord."; return; }
  if(!currentProfile?.department){ qaMsg.textContent = "Complète ton profil (département) puis enregistre."; return; }

  const meQA = currentProfile?.qa || getQA();
  const depSet = allowedDeps(currentProfile.department, meQA.neighbors);

  const myClub = normalizeClub(currentProfile.club || "");
  const useClubFilter = !!meQA.clubOnly && !!myClub;

  matchResults.innerHTML = "<div class='box'>Recherche en cours...</div>";

  try{
    const q = query(collection(db,"profiles"), where("is_active","==",true));
    const snap = await getDocs(q);

    const candidates = [];
    snap.forEach(d=>{
      if(d.id === currentUser.uid) return;
      const p = d.data();

      const otherDep = normalizeDep(p.department);
      if(!depSet.has(otherDep)) return;

      if(useClubFilter){
        const otherClub = normalizeClub(p.club || "");
        if(!otherClub || otherClub !== myClub) return;
      }

      const otherQA = p.qa || null;
      if(!isGenderAllowed(meQA, otherQA)) return;

      const score = compatibilityScore(meQA, otherQA);
      candidates.push({ uid: d.id, name: p.display_name || "Joueur", dep: p.department || "", club: p.club || "", score });
    });

    candidates.sort((a,b)=> b.score - a.score);

    if(candidates.length === 0){
      matchResults.innerHTML = "<div class='box'><span class='muted'>Aucun binôme trouvé avec tes filtres.</span></div>";
      return;
    }

    const top = candidates.slice(0, 10);
    matchResults.innerHTML = top.map(c => `
      <div class="matchCard">
        <div class="matchRow">
          <div>
            <strong>${c.name}</strong>
            <span class="badge">Dep ${c.dep}</span>
            ${c.club ? `<span class="badge">Club: ${c.club}</span>` : ``}
            <br>
            <span class="small">Compatibilité estimée</span>
          </div>
          <div class="matchScore">${c.score}%</div>
        </div>
        <button type="button" class="btnContactMatch"
          data-uid="${c.uid}"
          data-name="${encodeURIComponent(c.name)}">
          Contacter (chat)
        </button>
      </div>
    `).join("");

    document.querySelectorAll(".btnContactMatch").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const uid = btn.dataset.uid;
        const name = decodeURIComponent(btn.dataset.name || "Joueur");
        await openChat(uid, name);
      });
    });

  }catch(e){
    matchResults.innerHTML = "<div class='box'><span class='muted'>Erreur matching.</span></div>";
    qaMsg.textContent = "Erreur matching: " + (e?.message || e);
    console.log("match error", e);
  }
});

/* =========================
   CHAT + INBOX
   Fix CRITIQUE: participants triés pour éviter permission-denied user2
========================= */
function sortedParticipants(a, b){
  return (a < b) ? [a, b] : [b, a];
}
async function ensureChatDoc(chatId, uidA, uidB){
  const parts = sortedParticipants(uidA, uidB);
  await setDoc(doc(db,"chats",chatId), { participants: parts }, { merge: true });
}

async function loadInbox(){
  inboxMsg.textContent = "";
  inbox.innerHTML = "Chargement...";
  try{
    const qInbox = query(
      collection(db, "inbox", currentUser.uid, "chats"),
      orderBy("last_message_at_ms", "desc"),
      limit(50)
    );
    const snap = await getDocs(qInbox);

    if(snap.empty){
      inbox.innerHTML = "<p class='muted'>Aucune conversation.</p>";
      return;
    }

    const nameCache = new Map();
    async function getName(uid){
      if(nameCache.has(uid)) return nameCache.get(uid);
      try{
        const ps = await getDoc(doc(db,"profiles",uid));
        const nm = ps.exists() ? (ps.data().display_name || uid) : uid;
        nameCache.set(uid, nm);
        return nm;
      }catch{ return uid; }
    }

    inbox.innerHTML = "";
    for(const d of snap.docs){
      const c = d.data();
      const chatId = d.id;
      const ouid = c.other_uid;
      const oname = await getName(ouid);

      const box = document.createElement("div");
      box.className = "box";
      box.innerHTML = `
        <strong>${oname}</strong><br>
        <span class="muted">${(c.last_message_preview||"").slice(0,120)}</span><br>
      `;
      const b = document.createElement("button");
      b.type = "button";
      b.textContent = "Ouvrir";
      b.onclick = ()=>openChat(ouid, oname, chatId);
      box.appendChild(b);
      inbox.appendChild(box);
    }

  }catch(err){
    inbox.innerHTML = "<p class='muted'>Inbox indisponible.</p>";
    inboxMsg.textContent = "Erreur inbox: " + (err?.message || err) + " | code=" + (err?.code||"");
    logDebug("inbox.error", err);
  }
}
btnInbox.addEventListener("click", loadInbox);

async function openChat(uid, name, forcedChatId=null){
  if(unsubMsgs) unsubMsgs();
  unsubMsgs = null;

  otherUid = uid;
  otherName = name;
  currentChatId = forcedChatId || pairKey(currentUser.uid, uid);

  chatBox.classList.remove("hidden");
  chatTitle.textContent = "Chat avec " + (name || "Joueur");
  chatInfo.textContent = "chatId: " + currentChatId;
  chatMsg.textContent = "";
  msgsDiv.innerHTML = "Chargement...";

  // STEP0 safe
  try{
    await ensureChatDoc(currentChatId, currentUser.uid, uid);
  }catch(e){
    chatMsg.textContent = "Erreur ouverture chat (STEP0): " + (e?.message || e) + " | code=" + (e?.code||"");
    console.log("openChat STEP0 error", e);
    msgsDiv.innerHTML = "<span class='muted'>Impossible d’ouvrir le chat.</span>";
    return;
  }

  const qMsgs = query(
    collection(db, "chats", currentChatId, "messages"),
    orderBy("created_at_ms","asc"),
    limit(200)
  );

  unsubMsgs = onSnapshot(qMsgs, (snap)=>{
    msgsDiv.innerHTML = "";
    if(snap.empty){
      msgsDiv.innerHTML = "<span class='muted'>Aucun message.</span>";
      return;
    }
    snap.forEach(d=>msgsDiv.appendChild(renderMessage(d.data())));
    msgsDiv.scrollTop = msgsDiv.scrollHeight;
  }, (err)=>{
    chatMsg.textContent = "Erreur chat: " + (err?.message || err) + " | code=" + (err?.code||"");
    logDebug("chat.listen.error", err);
  });
}

btnCloseChat.addEventListener("click", ()=>{
  chatBox.classList.add("hidden");
  msgsDiv.innerHTML = "";
  chatMsg.textContent = "";
  currentChatId = null;
  otherUid = null;
  otherName = null;
  if(unsubMsgs) unsubMsgs();
  unsubMsgs = null;
});

btnSend.addEventListener("click", async ()=>{
  const text = msgInput.value.trim();
  if(!text || !currentChatId || !otherUid) return;

  btnSend.disabled = true;
  chatMsg.textContent = "";

  const chatRef = doc(db, "chats", currentChatId);
  const msgsRef = collection(db, "chats", currentChatId, "messages");

  // STEP 0
  try{
    await ensureChatDoc(currentChatId, currentUser.uid, otherUid);
  }catch(e0){
    chatMsg.textContent = "Erreur STEP0 (ensureChatDoc): " + (e0?.message || e0) + " | code=" + (e0?.code||"");
    logDebug("STEP0 error", e0);
    btnSend.disabled = false;
    return;
  }

  // STEP 1
  try{
    await addDoc(msgsRef, {
      sender_id: currentUser.uid,
      content: text,
      created_at_ms: Date.now()
    });
  }catch(e1){
    chatMsg.textContent = "Erreur STEP1 (addDoc message): " + (e1?.message || e1) + " | code=" + (e1?.code||"");
    logDebug("STEP1 error", e1);
    btnSend.disabled = false;
    return;
  }

  // STEP 2
  try{
    const now = Date.now();
    const preview = text.slice(0,120);

    await updateDoc(chatRef, {
      last_message_at_ms: now,
      last_message_preview: preview,
      last_message_sender: currentUser.uid
    });

    await setDoc(doc(db, "inbox", currentUser.uid, "chats", currentChatId), {
      other_uid: otherUid,
      last_message_at_ms: now,
      last_message_preview: preview
    }, { merge: true });

    await setDoc(doc(db, "inbox", otherUid, "chats", currentChatId), {
      other_uid: currentUser.uid,
      last_message_at_ms: now,
      last_message_preview: preview
    }, { merge: true });

  }catch(e2){
    chatMsg.textContent = "Message envoyé ✅ mais erreur STEP2 (meta/inbox): " + (e2?.message || e2) + " | code=" + (e2?.code||"");
    logDebug("STEP2 error", e2);
  }

  msgInput.value = "";
  await loadInbox();
  btnSend.disabled = false;
});

/* =========================
   Auth state
========================= */
onAuthStateChanged(auth, async (u)=>{
  currentUser = u;

  if(!u){
    appView.classList.add("hidden");
    authView.classList.remove("hidden");
    chatBox.classList.add("hidden");
    return;
  }

  authView.classList.add("hidden");
  appView.classList.remove("hidden");
  userLine.textContent = `Connecté: ${u.email} | uid=${u.uid} | projectId=${app.options.projectId}`;

  currentProfile = await loadProfile(u.uid);
  applyHints();
  await loadInbox();
});
</script>

</body>
</html>
