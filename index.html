<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Padel Binôme</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{font-family:system-ui;margin:16px}
    .card{max-width:760px;margin:0 auto;border:1px solid #ddd;border-radius:14px;padding:16px}
    input,select,button{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:10px}
    button{cursor:pointer}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    .muted{color:#666;font-size:14px}
    .hidden{display:none}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    label.chip{border:1px solid #ccc;border-radius:999px;padding:6px 10px;display:flex;gap:6px;align-items:center}
    hr{margin:16px 0}
  </style>
</head>
<body>

<div class="card">
  <h2>Padel Binôme</h2>

  <!-- AUTH -->
  <div id="authView">
    <h3>Connexion / Inscription</h3>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Mot de passe (min 6)">
    <div class="row">
      <button id="btnLogin">Se connecter</button>
      <button id="btnSignup">Créer un compte</button>
    </div>
    <p class="muted" id="authMsg"></p>
  </div>

  <!-- APP -->
  <div id="appView" class="hidden">
    <div class="row">
      <div><p id="userLine" class="muted"></p></div>
      <div><button id="btnLogout">Se déconnecter</button></div>
    </div>

    <hr>

    <h3>Mon profil joueur</h3>

    <input id="display_name" placeholder="Pseudo / Prénom">
    <input id="department" placeholder="Département (ex: 75)">
    <input id="club" placeholder="Club (optionnel)">

    <select id="frequency">
      <option value="1">1x / semaine</option>
      <option value="2">2x / semaine</option>
      <option value="3">3x / semaine</option>
      <option value="4">4x / semaine</option>
      <option value="5">5+ / semaine</option>
    </select>

    <p class="muted">Créneaux (plusieurs choix)</p>
    <div class="chips" id="slotsWrap"></div>

    <select id="level"></select>

    <select id="objective">
      <option value="leisure">Loisir</option>
      <option value="progress">Progression</option>
      <option value="tournament">Tournois</option>
      <option value="performance">Performance</option>
    </select>

    <select id="side_pref">
      <option value="left">Côté gauche</option>
      <option value="right">Côté droit</option>
      <option value="either">Indifférent</option>
    </select>

    <select id="style">
      <option value="offensive">Offensif</option>
      <option value="builder">Patient</option>
      <option value="defensive">Défenseur</option>
      <option value="versatile">Polyvalent</option>
    </select>

    <select id="communication">
      <option value="low">Silencieux</option>
      <option value="normal">Normal</option>
      <option value="high">Très communicant</option>
    </select>

    <select id="mental">
      <option value="stable">Stable</option>
      <option value="sometimes_tilt">Parfois je tilt</option>
      <option value="often_tilt">Je tilt souvent</option>
    </select>

    <p class="muted">Attentes partenaire (2 max)</p>
    <div class="chips" id="needsWrap"></div>

    <div class="row">
      <button id="btnSave">Enregistrer</button>
      <button id="btnToggleActive">Visible / Invisible</button>
    </div>

    <p class="muted" id="saveMsg"></p>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAN3k8oOsG_42wRmmkdHqKs7XjIamNiVy4",
  authDomain: "padel-binome.firebaseapp.com",
  projectId: "padel-binome",
  storageBucket: "padel-binome.firebasestorage.app",
  messagingSenderId: "968501656511",
  appId: "1:968501656511:web:464dca20866e202d53ff0a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// UI refs
const authView = document.getElementById("authView");
const appView = document.getElementById("appView");
const authMsg = document.getElementById("authMsg");
const saveMsg = document.getElementById("saveMsg");
const userLine = document.getElementById("userLine");

// Options
const slotsOptions = [
  ["week_evening","Semaine soir"],
  ["weekend","Week-end"],
  ["lunch","Midi"],
  ["flex","Variable"]
];
const needsOptions = [
  ["consistency","Régularité"],
  ["aggression","Agressivité"],
  ["coaching","Coaching"],
  ["good_vibes","Bonne ambiance"],
  ["serious","Sérieux"],
  ["adaptability","Adaptabilité"]
];

// Build selects
const levelSel = document.getElementById("level");
for(let i=1;i<=10;i++){
  const o=document.createElement("option");
  o.value=i;o.textContent="Niveau "+i;
  levelSel.appendChild(o);
}

// Chips
function buildChips(wrapId, opts){
  const w=document.getElementById(wrapId); w.innerHTML="";
  opts.forEach(([v,l])=>{
    const lab=document.createElement("label"); lab.className="chip";
    const cb=document.createElement("input"); cb.type="checkbox"; cb.value=v;
    lab.appendChild(cb); lab.appendChild(document.createTextNode(l));
    w.appendChild(lab);
  });
}
buildChips("slotsWrap",slotsOptions);
buildChips("needsWrap",needsOptions);

function getChecked(id){
  return Array.from(document.querySelectorAll(`#${id} input:checked`)).map(x=>x.value);
}
function setChecked(id,vals){
  const s=new Set(vals||[]);
  document.querySelectorAll(`#${id} input`).forEach(cb=>cb.checked=s.has(cb.value));
}

// Limit needs to 2
document.getElementById("needsWrap").addEventListener("change",()=>{
  const c=getChecked("needsWrap");
  if(c.length>2){
    const all=document.querySelectorAll("#needsWrap input");
    for(let i=all.length-1;i>=0;i--){
      if(all[i].checked){all[i].checked=false;break;}
    }
    saveMsg.textContent="2 attentes max.";
  }
});

async function loadProfile(uid){
  const ref=doc(db,"profiles",uid);
  const snap=await getDoc(ref);
  if(!snap.exists()) return null;
  const p=snap.data();
  display_name.value=p.display_name||"";
  department.value=p.department||"";
  club.value=p.club||"";
  frequency.value=p.frequency||1;
  setChecked("slotsWrap",p.slots||[]);
  level.value=p.level||1;
  objective.value=p.objective||"leisure";
  side_pref.value=p.side_pref||"either";
  style.value=p.style||"versatile";
  communication.value=p.communication||"normal";
  mental.value=p.mental||"stable";
  setChecked("needsWrap",p.partner_needs||[]);
  return p;
}

async function saveProfile(uid,existing){
  const payload={
    display_name:display_name.value.trim(),
    department:department.value.trim(),
    club:club.value.trim(),
    frequency:+frequency.value,
    slots:getChecked("slotsWrap"),
    level:+level.value,
    objective:objective.value,
    side_pref:side_pref.value,
    style:style.value,
    communication:communication.value,
    mental:mental.value,
    partner_needs:getChecked("needsWrap"),
    is_active:existing?.is_active??true,
    updated_at:serverTimestamp(),
    created_at:existing?.created_at??serverTimestamp()
  };
  await setDoc(doc(db,"profiles",uid),payload,{merge:true});
  return payload;
}

// Auth actions
btnSignup.onclick=async()=>{
  try{await createUserWithEmailAndPassword(auth,email.value,password.value);authMsg.textContent="";}
  catch(e){authMsg.textContent=e.message;}
};
btnLogin.onclick=async()=>{
  try{await signInWithEmailAndPassword(auth,email.value,password.value);authMsg.textContent="";}
  catch(e){authMsg.textContent=e.message;}
};
btnLogout.onclick=()=>signOut(auth);

let currentUser=null, currentProfile=null;

btnSave.onclick=async()=>{
  try{
    saveMsg.textContent="Enregistrement...";
    currentProfile=await saveProfile(currentUser.uid,currentProfile);
    saveMsg.textContent="Profil enregistré ✅";
  }catch(e){saveMsg.textContent=e.message;}
};
btnToggleActive.onclick=async()=>{
  const v=!(currentProfile?.is_active??true);
  await setDoc(doc(db,"profiles",currentUser.uid),{is_active:v,updated_at:serverTimestamp()},{merge:true});
  currentProfile={...(currentProfile||{}),is_active:v};
  saveMsg.textContent=v?"Visible":"Invisible";
};

onAuthStateChanged(auth,async(user)=>{
  currentUser=user;
  if(!user){
    appView.classList.add("hidden"); authView.classList.remove("hidden");
    return;
  }
  authView.classList.add("hidden"); appView.classList.remove("hidden");
  userLine.textContent=`Connecté: ${user.email}`;
  currentProfile=await loadProfile(user.uid);
});
</script>

</body>
</html>
